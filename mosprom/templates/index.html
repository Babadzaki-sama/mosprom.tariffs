<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ЕАИС - Оценка мер ТТП</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; }
        .search-form { display: flex; gap: 10px; margin-bottom: 20px; }
        .input-group { flex: 1; }
        input, button { padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        button { background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        .results { margin-top: 30px; }
        .recommendation { border: 1px solid #e0e0e0; padding: 15px; margin: 10px 0; border-radius: 5px; background: #f9f9f9; }
        .confidence { float: right; background: #28a745; color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px; }
        .suggestions { border: 1px solid #ddd; max-height: 200px; overflow-y: auto; display: none; position: absolute; background: white; width: 100%; z-index: 1000; }
        .suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .suggestion-item:hover { background: #f0f0f0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Единая аналитическая информационная система</h1>
            <p>Оценка эффективности мер таможенно-тарифного регулирования</p>
        </div>

        <div class="search-form">
            <div class="input-group" style="position: relative;">
                <input type="text" id="productName" placeholder="Наименование товара" style="width: 100%;">
                <div id="suggestions" class="suggestions"></div>
            </div>
            <div class="input-group">
                <input type="text" id="tnvedCode" placeholder="Код ТН ВЭД (6/10 знаков)" maxlength="10" style="width: 100%;">
            </div>
            <button onclick="analyzeTTP()">Проанализировать</button>
        </div>

        <div id="loading" style="display: none; text-align: center;">
            <p>Анализ данных... Пожалуйста, подождите.</p>
        </div>

        <div id="results" class="results" style="display: none;">
            <h2>Результаты анализа</h2>
            <div id="recommendationsList"></div>
            <div id="visualization" style="margin-top: 30px;"></div>
        </div>
    </div>

    <script>
        // Автодополнение товаров
        document.getElementById('productName').addEventListener('input', function(e) {
            const query = e.target.value;
            if (query.length < 2) {
                document.getElementById('suggestions').style.display = 'none';
                return;
            }

            fetch(`/api/product-suggestions?query=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(suggestions => {
                    const suggestionsDiv = document.getElementById('suggestions');
                    suggestionsDiv.innerHTML = '';
                    
                    if (suggestions.length > 0) {
                        suggestions.forEach(item => {
                            const div = document.createElement('div');
                            div.className = 'suggestion-item';
                            div.textContent = `${item.code} - ${item.name}`;
                            div.onclick = () => {
                                document.getElementById('productName').value = item.name;
                                document.getElementById('tnvedCode').value = item.code;
                                suggestionsDiv.style.display = 'none';
                            };
                            suggestionsDiv.appendChild(div);
                        });
                        suggestionsDiv.style.display = 'block';
                    } else {
                        suggestionsDiv.style.display = 'none';
                    }
                });
        });

        // Анализ мер ТТП
        function analyzeTTP() {
            const productName = document.getElementById('productName').value;
            const tnvedCode = document.getElementById('tnvedCode').value;

            if (!productName || !tnvedCode) {
                alert('Пожалуйста, заполните все поля');
                return;
            }

            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';

            fetch('/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    product_name: productName,
                    tnved_code: tnvedCode
                })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('results').style.display = 'block';
                displayResults(data);
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('loading').style.display = 'none';
                alert('Произошла ошибка при анализе данных');
            });
        }

        function displayResults(data) {
            const recommendationsList = document.getElementById('recommendationsList');
            recommendationsList.innerHTML = '';

            if (data.recommendations && data.recommendations.length > 0) {
                data.recommendations.forEach(rec => {
                    const recDiv = document.createElement('div');
                    recDiv.className = 'recommendation';
                    
                    const confidence = document.createElement('span');
                    confidence.className = 'confidence';
                    confidence.textContent = `Уверенность: ${(rec.confidence_score * 100).toFixed(0)}%`;
                    
                    recDiv.innerHTML = `
                        <h3>${rec.measure}</h3>
                        <p><strong>Целевые страны:</strong> ${rec.target_countries.join(', ')}</p>
                        <p><strong>Обоснование:</strong> ${rec.justification}</p>
                        ${rec.coverage_percentage ? `<p><strong>Покрытие внутренним производством:</strong> ${rec.coverage_percentage.toFixed(1)}%</p>` : ''}
                    `;
                    
                    recDiv.appendChild(confidence);
                    recommendationsList.appendChild(recDiv);
                });

                createVisualization(data.recommendations);
            } else {
                recommendationsList.innerHTML = '<p>По вашему запросу рекомендации не найдены.</p>';
            }
        }

        function createVisualization(recommendations) {
            const measures = recommendations.map(r => {
                const measureName = r.measure.split(' - ')[0]; // Берем только первую часть названия
                return measureName.length > 50 ? measureName.substring(0, 50) + '...' : measureName;
            });
            const confidence = recommendations.map(r => r.confidence_score * 100);

            const trace = {
                x: measures,
                y: confidence,
                type: 'bar',
                marker: {
                    color: confidence.map(c => 
                        c > 80 ? '#28a745' : c > 60 ? '#ffc107' : '#dc3545'
                    )
                }
            };

            const layout = {
                title: 'Уверенность в рекомендациях по мерам ТТП',
                xaxis: { title: 'Меры ТТП', tickangle: -45 },
                yaxis: { title: 'Уверенность (%)', range: [0, 100] },
                height: 400
            };

            Plotly.newPlot('visualization', [trace], layout);
        }
    </script>
</body>
</html>